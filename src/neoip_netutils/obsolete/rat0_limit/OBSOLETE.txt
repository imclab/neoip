this is a old poortly code implementation, use rate_sched_t and rate_limit_t
- it is much nicerly coded and allow a scheduler